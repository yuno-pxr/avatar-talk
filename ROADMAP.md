# avatar-talk 開発ロードマップ
（複数アバター / 発話アサイン / Zettelkasten 連携エンジン）

## 目的
- `widget_prj` をベースに、以下の高度な機能を実装する：
  - **複数アバター同時表示 / モード切替**
  - **Zettelkasten（話題グラフ）による無限雑談エンジン**
  - **役割分担型マルチエージェント AI（Navigator, Responder, Critic, Curator）**
  - **外部対話エンジンとの WebSocket 連携**

本プロジェクトは **「表示・音声再生・UI」** に責務を限定し、高度な推論ロジックは外部エンジンに委譲する。

---

## 全体方針（重要）
- **既存挙動を維持**: 壊さずに拡張し、常に「動く状態」を保つ。
- **Zettelkasten は「地図」**: 知識検索ではなく「連想の道筋」としてグラフを活用する。
- **マルチエージェント分業**: 1つのプロンプトに詰め込まず、役割を分けて精度と安定性を高める。

---

## Phase 0 | 事前準備 (完了)
- ✅ リポジトリ `avatar-talk` の作成
- ✅ 基盤コードの移行とリブランディング

---

## Phase 1 | 内部構造の拡張（見た目不変）
### 1.1 Avatar 管理のコレクション化
- `AvatarManager` による複数 `AvatarInstance` の管理。
- 1体のみ表示の状態を維持しつつ、データ構造を配列化する。

### 1.2 高機能 SpeechEvent の定義
```ts
type SpeechEvent = {
  speakerId: string;
  text: string;
  emotion?: string;
  isInterrupt?: boolean; // 割り込みフラグ
  metadata?: {
    noteId?: string;     // 参照したZettelkastenノート
    nextQuestions?: string[]; // 次の問いの候補
  }
}
```

---

## Phase 2 & 3 | モード切替と話者アサイン
- **ソロ / 掛け合いモード**の実装。
- **Speaker → Voice マッピング**: 複数の AI 話者に異なるボイスを割り当て、再生キューを分離。
- **強調表示**: 話しているアバターの Z-index 上昇、軽いアニメーション。

---

## Phase 4 & 5 | 複数表示と割り込み UI
- **複数アバター同時描画**: 左右配置などのレイアウト対応。
- **インタラプト UI**: 割り込み発話をテロップやサブウィンドウで表示。
- **割り込み制御**: 文末や無音時間を検知して割り込みを許可するロジック。

---

## Phase 6 | インテリジェント・エンジンの構築（核心）
※ ここからは外部エンジン（Python/Node.js 等）側の設計。

### 6.1 Zettelkasten Topic Graph
- **1ノート = 1アイデア**: 固有 ID を持つ短いノート群。
- **リンク = 連想**: ノート間の関係性をグラフデータベース（または単純な JSON 構造）で管理。
- **探索アルゴリズム**: 現在の話題から「近傍かつ未踏」のリンクを抽出する。

### 6.2 マルチエージェント・役割定義
1. **Navigator (話題遷移)**: Zettelkasten を歩き、次に話す「ノート」と「問い」を提案。
2. **Responder (対話生起)**: 選択されたノートを元に、自然な雑談テキストを生成。
3. **Critic (整合性監視)**: 自己矛盾や言い過ぎをチェックし、修正指示を出す。
4. **Memory Curator (知識抽出)**: 会話から新情報を抽出し、Zettelkasten へ追記。

### 6.3 「無限」対話ロジック
- 返答の末尾に、参照ノートに基づいた「次の質問」を 2〜5 個自動生成。
- ユーザーが無反応なら Navigator が自動で 1 つ選択して進める。

---

## Phase 7 | 外部連携 & ログ
- **WebSocket / IPC プロトコル**: `avatar-talk` とエンジンの間の通信規格を策定。
- **Zettelkasten 連携フック**: ウィジェット側でログを保存し、外部で要約・リンク化。

---

## 工数目安
| Phase | 内容 | 日数 |
| :--- | :--- | :--- |
| Phase 1-3 | 構造拡張・アサイン | 7-10日 |
| Phase 4-5 | 複数表示・割り込み | 5-7日 |
| Phase 6 | エンジン・Zettelkasten | 7-14日 |
| Phase 7 | 連携・最終調整 | 3-5日 |

合計：約 4〜6 週間（1人開発）
